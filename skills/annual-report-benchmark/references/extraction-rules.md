# 年报取数规则

## 目录

- [0. 术语](#0-术语)
- [1. 输入与下载](#1-输入与下载)
- [2. 解析标准](#2-解析标准)
- [3. 单公司执行顺序](#3-单公司执行顺序)
- [4. 两轮止损（硬性）](#4-两轮止损硬性)
- [5. 同义词识别映射](#5-同义词识别映射仅识别不可作为输出名)
- [6. 可追溯字段](#6-可追溯字段每行至少包含)
- [7. 多公司聚合](#7-多公司聚合)

---

## 0. 术语

- 报告期：`Y`
- 对比期：`Y-1`
- 输出字段名：仅允许使用 `references/required-fields.md` 中的 23 项标准名称。

## 1. 输入与下载

- 每家公司必须下载 `Y` 与 `Y-1` 两份年报。
- 单家公司失败不阻断其他公司——前提是已产出该公司的降级表（可提取字段 + 缺失清单 + 失败原因）；降级表视为已产出，满足"产出单公司表"要求后方可继续处理下一家。

## 2. 解析标准

- 执行前必须读取 `references/pdf-parsing.md`。
- 每份 PDF 仅执行一次 `PDF -> DOCX` 转换（使用 `pdf2docx-mcp`）。
- 后续取数仅基于该 DOCX 文件，不再回退其它格式。

## 3. 单公司执行顺序

1. 先按 23 项字段构建空骨架。
2. 提取核心章节：主要会计数据和财务指标。
3. 提取报表基础项：资产负债表、利润表、现金流量表。
4. 提取员工薪酬章节。
   - **应付职工薪酬本期减少合计金额**：位于附注"应付职工薪酬列示"表格，取"合计"行的"本期减少"列数值。该表结构为：项目 | 期初余额 | 本期增加 | 本期减少 | 期末余额，包含短期薪酬、离职后福利、辞退福利等行，取最底部合计行的本期减少值。
5. 搜索"尚未履行或尚未履行完毕的履约义务所对应的收入金额"相关描述：
   - 如有披露数值，则提取并加入当前公司表，参与对标。
   - 如未披露（含"无"、"不适用"、空白），则跳过，不占位，不影响覆盖率校验。
6. 计算派生指标（按 `metric-definitions.md`）。
7. 回填对比期值：优先 `Y` 年报对比列，缺失则从 `Y-1` 年报补提。
8. 计算同比并写入质量标记。
9. 执行 23 项覆盖率校验；缺失项必须占位。

## 4. 两轮止损（硬性）

- 每家公司最多 2 轮自动提取。
- 第 1 轮：完整流程提取。
- 第 2 轮：仅允许针对缺失项做定向补提。
- 第 2 轮后仍不达标：立即降级，产出
  - 单公司对比表（可提取字段）
  - 缺失项清单
  - 失败原因说明
- 未产出当前公司单公司表，不得进入下一家公司或总表聚合。

## 5. 同义词识别映射（仅识别，不可作为输出名）

- `归属于上市公司股东的净利润` -> `归属于母公司股东的净利润`
- `在职员工的数量合计` -> `报告期末在职员工的数量合计`

## 6. 可追溯字段（每行至少包含）

- 指标名称
- `Y年值`
- `Y-1年值`
- 同比
- 单位
- 数据质量
- 来源章节
- 报告期值来源年报
- 对比期值来源年报
- 备注

## 7. 多公司聚合

- 必须先完成全部单公司表，再生成总对比大表。
- 聚合时不得删除缺失指标行。
